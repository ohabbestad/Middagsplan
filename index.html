import React, { useState, useMemo } from 'react';
import { 
  Printer, Clock, Star, Utensils, Calendar, 
  ShoppingCart, Check, Copy, X, ArrowLeftRight 
} from 'lucide-react';

// --- KATEGORIER ---
const CAT_LABELS = {
  p: "Frukt & Grønt",
  m: "Kjøtt & Fisk",
  d: "Meieri & Kjøl",
  g: "Tørrvarer & Annet"
};

// --- DATA ---
const weeksData = {
  1: [
    {
      day: "Mandag",
      options: [
        {
          title: "Fiskeburgere",
          description: "Kjapt, sunt og barnevennlig middag på 15 min.",
          tags: ["Raskt"],
          ingredients: [
            { t: 'm', i: "800g grove fiskekaker (80%)" },
            { t: 'g', i: "8 grove hamburgerbrød" },
            { t: 'p', i: "1 stk isbergsalat" },
            { t: 'p', i: "2-3 tomater" },
            { t: 'p', i: "1 agurk" },
            { t: 'g', i: "1 pk remulade" },
            { t: 'g', i: "Sylteagurk" }
          ],
          steps: [
            "Sett stekeovnen på 200 grader varmluft. Finn frem et stekebrett og dekk det med bakepapir.",
            "Skyll isbergsalat, tomat og agurk godt i kaldt vann.",
            "Riv salatbladene i passe store biter. Skjær tomat og agurk i tynne skiver. Legg grønnsakene i skåler.",
            "Legg fiskekakene på stekebrettet. Sett brettet midt i ovnen og la dem steke i ca. 10-12 minutter til de er gjennomvarme.",
            "Når det gjenstår 2-3 minutter av steketiden: Legg hamburgerbrødene inn i ovnen (enten på risten over eller ved siden av kakene) slik at de blir litt lune og sprø.",
            "Ta alt ut av ovnen. Sett frem fiskekaker, brød, grønnsaker, remulade og sylteagurk på bordet.",
            "La alle montere sin egen burger ved bordet."
          ]
        },
        {
          title: "Fiskepinner & Potetmos",
          description: "En sikker vinner hos barna med hjemmelaget mos.",
          tags: ["Raskt"],
          ingredients: [
            { t: 'm', i: "800g fiskepinner" },
            { t: 'p', i: "1 kg kokefaste poteter" },
            { t: 'p', i: "4 gulrøtter" },
            { t: 'd', i: "2 ss smør" },
            { t: 'd', i: "2 dl melk" }
          ],
          steps: [
            "Skrell potetene. Del hver potet i 4 biter (da koker de fortere). Ha dem i en kjele og fyll på med vann til det dekker potetene. IKKE ha salt i vannet (da blir mosen seig). Kok opp og la småkoke til de er helt møre (stikk en gaffel i dem, den skal gli lett gjennom), ca. 15-20 min.",
            "Mens potetene koker: Sett ovnen på 225 grader varmluft. Legg fiskepinnene på et stekebrett med bakepapir. Stek midt i ovnen i ca. 12-15 minutter. Snu dem gjerne halvveis for sprøere skorpe.",
            "Skrell gulrøttene og rasp dem på et rivjern (den siden med mellomstore hull). Ha raspet gulrot i en skål.",
            "Når potetene er møre: Hell av vannet. Bruk en potetstamper til å knuse potetene godt. Tilsett smør og rør rundt.",
            "Spe med litt og litt melk mens du rører kraftig (gjerne med en visp) til mosen har fått den konsistensen du liker. Smak til med salt og pepper.",
            "Server fiskepinner med potetmos og revet gulrot."
          ]
        }
      ]
    },
    {
      day: "Tirsdag",
      options: [
        {
          title: "Spagetti Bolognese",
          description: "Klassiker hvor vi lurer inn ekstra grønnsaker.",
          tags: [],
          ingredients: [
            { t: 'm', i: "400g karbonadedeig" },
            { t: 'g', i: "2 bokser hakkede tomater" },
            { t: 'g', i: "2 ss tomatpuré" },
            { t: 'p', i: "1 gul løk" },
            { t: 'p', i: "2 fedd hvitløk" },
            { t: 'p', i: "2 gulrøtter" },
            { t: 'g', i: "500g fullkornsspagetti" },
            { t: 'g', i: "1 kjøttbuljongterning" }
          ],
          steps: [
            "Fyll en stor kjele med vann, ha i en teskje salt, og sett den på platen for å koke opp.",
            "Skrell løk og hvitløk. Finhakk dem (kutt i små biter). Skrell gulrøttene og rasp dem på rivjern.",
            "Varm en stekepanne på middels høy varme. Ha i litt smør eller olje. Ha i karbonadedeigen og hakk den i små biter med stekespaden mens den steker. Når alt kjøttet er brunt, legger du det til side på en tallerken.",
            "Skru varmen ned til middels. Ha litt ny olje i pannen. Stek løk og hvitløk til løken er blank og myk (ikke brunsvidd). Rør inn tomatpuré og revet gulrot, og la det frese i 1 minutt.",
            "Ha kjøttdeigen tilbake i pannen. Hell over bokser med hakkede tomater. Smuldre buljongterningen oppi.",
            "La sausen småkoke (boble forsiktig) i 10-15 minutter mens pastaen koker. Smak til med salt og pepper (evt. litt sukker hvis tomatene er sure).",
            "Når vannet i den store kjelen koker: Ha i spagettien. Kok etter tiden som står på pakken (ca 8-10 min). Hell av vannet i et dørslag.",
            "Server spagettien med kjøttsausen på toppen."
          ]
        },
        {
          title: "Pølsegrateng",
          description: "Nostalgi i form - perfekt for å bruke opp rester.",
          tags: [],
          ingredients: [
            { t: 'm', i: "600g kjøttpølse (skinnsfri)" },
            { t: 'g', i: "400g makaroni" },
            { t: 'd', i: "3 ss smør" },
            { t: 'g', i: "3 ss hvetemel" },
            { t: 'd', i: "5 dl melk" },
            { t: 'p', i: "1 brokkoli" },
            { t: 'd', i: "200g revet ost" }
          ],
          steps: [
            "Sett ovnen på 200 grader (over- og undervarme).",
            "Kok opp vann i en kjele. Ha i makaroni og kok etter anvisning på pakken. De siste 2-3 minuttene har du i brokkoli delt i små buketter. Hell av vannet.",
            "Kutt pølsene i terninger.",
            "Lag hvit saus: Smelt smør i en kjele på middels varme. Rør inn hvetemel med en visp. Spe med litt og litt melk mens du visper hele tiden for å unngå klumper. La sausen koke forsiktig i 5 minutter slik at melsmaken forsvinner. Smak til med salt og pepper.",
            "Finn frem en ildfast form. Bland sammen kokt makaroni, brokkoli, pølsebiter og den hvite sausen i formen.",
            "Strø revet ost over hele toppen.",
            "Stek midt i ovnen i ca. 20 minutter, til osten er smeltet og gyllen."
          ]
        }
      ]
    },
    {
      day: "Onsdag",
      options: [
        {
          title: "Kremet Pasta med Laks",
          description: "Luksusmiddag på 15 minutter.",
          tags: ["Raskt"],
          ingredients: [
            { t: 'm', i: "500g laksefilet" },
            { t: 'g', i: "500g tagliatelle" },
            { t: 'd', i: "3 dl matfløte eller kremfløte" },
            { t: 'g', i: "200g frosne erter" },
            { t: 'p', i: "1/2 sitron" }
          ],
          steps: [
            "Kok opp en stor kjele med saltet vann. Ha i pastaen og kok etter anvisning på pakken (ca 8-10 min).",
            "Mens pastaen koker: Skjær laksefileten i terninger på ca 2x2 cm.",
            "Varm en stekepanne på middels varme med litt smør. Stek laksebitene i 2-3 minutter. De trenger ikke være helt gjennomstekt, bare få litt farge.",
            "Hell fløten over fisken i pannen. Ha i de frosne ertene. La det småkoke (boble svakt) i 3-4 minutter til sausen tykner litt og ertene er varme.",
            "Når pastaen er ferdigkokt: Hell av vannet i et dørslag.",
            "Bland pastaen forsiktig inn i sausen med laksen. Skvis over litt saft fra sitronen og server."
          ]
        },
        {
          title: "Rask Fiskesuppe",
          description: "Varmende og god suppe med ekstra fyll.",
          tags: ["Raskt"],
          ingredients: [
            { t: 'g', i: "1 pose fiskesuppe" },
            { t: 'm', i: "400g fiskeboller eller laks" },
            { t: 'p', i: "2 gulrøtter" },
            { t: 'p', i: "1 purreløk" },
            { t: 'd', i: "2 dl matfløte" },
            { t: 'g', i: "Godt brød" }
          ],
          steps: [
            "Skrell gulrøttene og kutt dem i tynne strimler eller skiver. Vask purreløken godt og kutt den i ringer.",
            "Lag suppen fra pose: Tøm pulveret i en kjele. Rør inn væskemengden som står på pakken (bytt gjerne ut 2 dl av vannet med matfløten for bedre smak).",
            "Kok opp under omrøring. Når det koker, ha i gulrotbitene. La småkoke i 5 minutter.",
            "Del fiskebollene i to (eller laks i terninger) og ha dem i suppen sammen med purreløken.",
            "La suppen trekke (ikke fosskoke) i 5 minutter til, slik at fisken/bollene blir varme.",
            "Server med godt brød."
          ]
        }
      ]
    },
    {
      day: "Torsdag",
      options: [
        {
          title: "Kremet Kyllinggryte",
          description: "Alt i en gryte - mindre oppvask.",
          tags: [],
          ingredients: [
            { t: 'm', i: "600g kyllingfilet" },
            { t: 'p', i: "1 rød paprika" },
            { t: 'p', i: "1 gul løk" },
            { t: 'p', i: "150g sopp" },
            { t: 'd', i: "3 dl matfløte" },
            { t: 'g', i: "1 hønsebuljongterning" },
            { t: 'g', i: "Ris" }
          ],
          steps: [
            "Start med risen: Følg anvisningen på pakken (skyll risen, kok opp med vann og salt, la trekke under lokk).",
            "Kutt kyllingfiletene i munnfull-store biter. Kutt løk, paprika og sopp i grove biter.",
            "Varm en stekepanne/gryte med høye kanter på middels høy varme. Stek kyllingbitene i litt smør til de er gylne utenpå. Legg kyllingen til side på en tallerken.",
            "I samme gryte: Stek løk, sopp og paprika i noen minutter til løken er myk.",
            "Legg kyllingen tilbake i gryta sammen med grønnsakene.",
            "Hell over matfløten og smuldre buljongterningen oppi. Rør godt.",
            "La gryta småkoke i 5-10 minutter til sausen har tyknet litt og kyllingen er gjennomkokt (hvit tvers igjennom).",
            "Server gryten oppå risen."
          ]
        },
        {
          title: "Kylling Fajitas",
          description: "Litt krydret hverdagskos.",
          tags: [],
          ingredients: [
            { t: 'm', i: "600g kyllingfilet" },
            { t: 'g', i: "1 pk tortillalefser" },
            { t: 'p', i: "2 paprika" },
            { t: 'p', i: "1 stor løk" },
            { t: 'g', i: "1 pose Fajitas krydder" },
            { t: 'd', i: "1 beger lettrømme" },
            { t: 'g', i: "1 glass salsa" }
          ],
          steps: [
            "Skjær kyllingfileten i lange strimler. Skjær også paprika og løk i strimler.",
            "Varm en stor stekepanne på høy varme med litt olje. Stek kyllingen til den er gjennomstekt og har fått farge.",
            "Ha i paprika og løk sammen med kyllingen, og stek videre i 2-3 minutter. Grønnsakene skal bli varme, men fortsatt være litt sprø.",
            "Hell over krydderposen og mengden vann som står på baksiden av krydderposen. Rør godt og la det koke inn i 2 minutter.",
            "Varm tortillalefsene i mikrobølgeovn eller pakket i folie i stekeovnen.",
            "Sett alt på bordet. Fyll lefsene med kjøttblanding, salsa og rømme."
          ]
        }
      ]
    },
    {
      day: "Fredag",
      options: [
        {
          title: "Taco-Fredag",
          description: "Den hellige klassikeren.",
          tags: ["Helg"],
          ingredients: [
            { t: 'm', i: "400g kjøttdeig" },
            { t: 'g', i: "1 pose tacokrydder" },
            { t: 'g', i: "1 pk tacolefser" },
            { t: 'g', i: "1 pose tortillachips" },
            { t: 'd', i: "200g revet ost" },
            { t: 'd', i: "1 beger lettrømme" },
            { t: 'g', i: "1 glass tacosalsa" },
            { t: 'p', i: "1 agurk" },
            { t: 'p', i: "1 boks mais" },
            { t: 'p', i: "1 isbergsalat" },
            { t: 'p', i: "1 paprika" }
          ],
          steps: [
            "Varm en stekepanne på middels varme. Stek kjøttdeigen til den er brun. Tilsett tacokrydder og vann (ca 1 dl, se posen). La det koke til vannet er borte.",
            "Vask og kutt grønnsakene: Agurk og paprika i terninger, salat i strimler. Hell laken av maisen.",
            "Ha alle grønnsakene, ost, salsa, rømme og chips i egne skåler.",
            "Varm lefsene i ovn (pakket i folie, 200 grader i 5-8 min) eller i mikroen.",
            "Sett alt på bordet og nyt!"
          ]
        },
        {
          title: "Nachos i langpanne",
          description: "Tacoens gratinerte fetter.",
          tags: ["Helg"],
          ingredients: [
            { t: 'm', i: "400g kjøttdeig" },
            { t: 'g', i: "1 pose tacokrydder" },
            { t: 'g', i: "1 stor pose nachochips" },
            { t: 'd', i: "300g revet ost" },
            { t: 'g', i: "1 glass salsa" },
            { t: 'g', i: "1 boks bønner (valgfritt)" },
            { t: 'd', i: "1 beger rømme" },
            { t: 'p', i: "Vårløk" }
          ],
          steps: [
            "Sett ovnen på 225 grader.",
            "Stek kjøttdeigen brun i en panne. Bland inn tacokrydder og vann, og la det koke inn.",
            "Finn frem et stekebrett med bakepapir. Spre nachochipsene utover hele brettet.",
            "Fordel kjøttdeigen jevnt over chipsene. Legg på klatter med salsa. Hvis du bruker bønner (skyll dem først), strø dem over.",
            "Dryss over rikelig med revet ost.",
            "Sett brettet midt i ovnen og stek i ca. 5-8 minutter. Følg med! Det er ferdig når osten er smeltet og bobler litt.",
            "Strø over hakket vårløk ved servering og server med rømme."
          ]
        }
      ]
    },
    {
      day: "Lørdag",
      options: [
        {
          title: "Hjemmelaget Lasagne",
          description: "Lages fra bunnen - mye bedre enn pose.",
          tags: ["Helg"],
          ingredients: [
            { t: 'm', i: "400g kjøttdeig" },
            { t: 'g', i: "1 pk lasagneplater" },
            { t: 'g', i: "2 bokser hakkede tomater" },
            { t: 'p', i: "1 løk" },
            { t: 'p', i: "2 fedd hvitløk" },
            { t: 'd', i: "3 ss smør" },
            { t: 'g', i: "3 ss hvetemel" },
            { t: 'd', i: "6 dl melk" },
            { t: 'd', i: "250g revet ost" },
            { t: 'g', i: "1 pk hvitløksbaguetter" },
            { t: 'p', i: "Isbergsalat" }
          ],
          steps: [
            "Sett ovnen på 200 grader.",
            "Lag kjøttsaus: Finhakk løk og hvitløk. Brun kjøttdeigen i en panne. Ha i løk/hvitløk og la det frese litt. Tøm over hakkede tomater. La koke i 5 min. Smak til med salt/pepper.",
            "Lag hvit saus: Smelt smør i en kjele. Visp inn mel. Spe med melk litt etter litt mens du visper så det ikke klumper seg. Kok opp og la koke 2 min. Trekk kjelen av platen og rør inn halvparten av osten.",
            "Montering: Finn en ildfast form. Legg litt kjøttsaus i bunnen. Legg på lasagneplater. Ha på hvit saus. Gjenta: Kjøttsaus -> Plater -> Hvit saus. Avslutt med hvit saus på toppen.",
            "Strø resten av osten over toppen.",
            "Stek midt i ovnen i ca 30-40 minutter. Kjenn etter med en kniv at platene er myke. Stek hvitløksbaguettene ved siden av de siste 10 minuttene."
          ]
        },
        {
          title: "Biffsnadder (Svin)",
          description: "Rimelig luksus med bearnaise.",
          tags: ["Helg"],
          ingredients: [
            { t: 'm', i: "500g strimlet svinekjøtt" },
            { t: 'p', i: "1 rød paprika" },
            { t: 'p', i: "1 løk" },
            { t: 'p', i: "100g sopp" },
            { t: 'd', i: "1 pk bearnaisesaus" },
            { t: 'd', i: "Smør/melk (til saus)" },
            { t: 'g', i: "1 pose pommes frites" },
            { t: 'p', i: "Isbergsalat" }
          ],
          steps: [
            "Legg pommes frites på et stekebrett og sett dem i ovnen (følg temp/tid på posen, ofte 225 grader i 15-20 min).",
            "Kutt paprika, løk og sopp i biter.",
            "Lag bearnaisesausen i en liten kjele etter anvisning på pakken. Hold den varm på lav varme (rør av og til så den ikke skiller seg).",
            "Varm en stekepanne godt med litt smør. Stek svinekjøttet raskt på høy varme. Ikke ta alt i pannen på en gang, da blir det kokt i stedet for stekt. Legg ferdig kjøtt til side.",
            "Stek grønnsakene i samme panne til de er myke.",
            "Når friesene er ferdige: Bland kjøttet tilbake i pannen med grønnsakene for å varme det opp.",
            "Server alt straks."
          ]
        }
      ]
    },
    {
      day: "Søndag",
      options: [
        {
          title: "Koteletter i form",
          description: "Mørt og godt, lager seg selv i ovnen.",
          tags: [],
          ingredients: [
            { t: 'm', i: "800g koteletter" },
            { t: 'p', i: "8-10 poteter" },
            { t: 'p', i: "3 gulrøtter" },
            { t: 'p', i: "1/2 kålrot" },
            { t: 'd', i: "3 dl kremfløte" }
          ],
          steps: [
            "Sett ovnen på 200 grader.",
            "Skrell poteter, gulrøtter og kålrot. Del potetene i båter og grønnsakene i grove biter (ca like store som potetbåtene).",
            "Legg alle grønnsakene i en stor ildfast form. Krydre med salt og pepper.",
            "Brun kotelettene raskt i en stekepanne med smør på høy varme (1 minutt på hver side for å få stekeskorpe). Legg dem oppå grønnsakene i formen.",
            "Hell fløten over formen.",
            "Sett formen midt i ovnen. La den stå i ca. 45-60 minutter. Maten er ferdig når du kan stikke en gaffel lett gjennom potetene."
          ]
        },
        {
          title: "Svinestek med surkål",
          description: "Klassisk søndagsmiddag.",
          tags: [],
          ingredients: [
            { t: 'm', i: "1 kg svinestek" },
            { t: 'p', i: "1 kg poteter" },
            { t: 'g', i: "1 pk surkål" },
            { t: 'g', i: "1 pose brun saus" },
            { t: 'p', i: "2 gulrøtter" },
            { t: 'g', i: "Tyttebærsyltetøy" }
          ],
          steps: [
            "Sett ovnen på 125 grader (langtidssteking gjør den mør). Gni steken inn med salt og pepper. Stikk et steketermometer inn i den tykkeste delen.",
            "Legg steken i en ildfast form og sett i ovnen. Den skal stå til termometeret viser 76 grader (dette tar ca 1.5 - 2 timer).",
            "Når steken er ferdig: Ta den ut og pakk den inn i aluminiumsfolie. La den hvile i 15-20 minutter før du skjærer i den (viktig for saftigheten).",
            "Mens steken hviler: Skrell poteter og gulrøtter. Kok dem møre i vann (ca 20 min).",
            "Varm surkål i en liten kjele. Lag brun saus etter anvisning på posen.",
            "Skjær steken i tynne skiver og server."
          ]
        }
      ]
    }
  ],
  2: [
    {
      day: "Mandag",
      options: [
        {
          title: "Kjøttboller & Makaroni",
          description: "Rask favoritt.",
          tags: ["Raskt"],
          ingredients: [
            { t: 'm', i: "1 pose kjøttboller" },
            { t: 'g', i: "500g makaroni" },
            { t: 'g', i: "1 pose brun saus" },
            { t: 'p', i: "1 brokkoli" },
            { t: 'g', i: "Tyttebærsyltetøy" }
          ],
          steps: [
            "Kok opp en kjele med vann til makaroni.",
            "I en annen kjele: Lag brun saus etter anvisning på posen (visp pulver ut i vann/melk, kok opp).",
            "Legg kjøttbollene oppi den ferdige sausen. La dem trekke (ligge i den varme sausen) på svak varme i ca 10 minutter til de er gjennomvarme.",
            "Ha makaroni i det kokende vannet. Kok etter tid på pakken. De siste 3-4 minuttene har du i brokkoli (delt i små buketter). Hell av vannet.",
            "Server kjøttboller i saus med makaroni, brokkoli og tyttebær."
          ]
        },
        {
          title: "Pasta med Pølser & Pesto",
          description: "Superkjapp middag.",
          tags: ["Raskt"],
          ingredients: [
            { t: 'm', i: "1 pk kjøttpølser" },
            { t: 'g', i: "500g pasta" },
            { t: 'g', i: "1 glass pesto" },
            { t: 'd', i: "1 dl matfløte" },
            { t: 'g', i: "1 boks mais" }
          ],
          steps: [
            "Kok pasta i en stor kjele med saltet vann etter anvisning på pakken.",
            "Mens pastaen koker: Skjær pølsene i biter. Stek dem gylne i en stekepanne med litt smør.",
            "Når pastaen er ferdig: Hell av vannet i vasken (bruk dørslag), og ha pastaen tilbake i kjelen.",
            "Rør inn hele glasset med pesto og matfløten. Bland godt.",
            "Tilsett de stekte pølsebitene og mais (hell av vannet på maisen først). Rør rundt til alt er varmt.",
            "Server straks."
          ]
        }
      ]
    },
    {
      day: "Tirsdag",
      options: [
        {
          title: "Ovnsbakt Laks",
          description: "Alt i en form - minimalt med oppvask.",
          tags: [],
          ingredients: [
            { t: 'm', i: "500g laksefilet" },
            { t: 'p', i: "1 brokkoli" },
            { t: 'p', i: "1 purreløk" },
            { t: 'd', i: "3 dl matfløte" },
            { t: 'g', i: "Sitronpepper" },
            { t: 'p', i: "8-10 poteter" }
          ],
          steps: [
            "Sett ovnen på 200 grader. Skrell potetene og sett dem på koking i en kjele med vann. De trenger ca 20-25 minutter.",
            "Del brokkolien i små buketter. Vask purren og skjær den i ringer. Skjær laksen i store terninger.",
            "Finn en ildfast form. Legg brokkoli, purre og laks i formen.",
            "Krydre godt med sitronpepper (eller salt og pepper).",
            "Hell matfløten over alt i formen.",
            "Sett formen i ovnen og la den steke i ca 15-20 minutter. Da bør laksen være ferdig (den flaker seg når du trykker på den).",
            "Server formen sammen med de kokte potetene."
          ]
        },
        {
          title: "Stekt Laks & Agurksalat",
          description: "Friskere variant.",
          tags: [],
          ingredients: [
            { t: 'm', i: "500g laksefilet" },
            { t: 'p', i: "1 agurk" },
            { t: 'g', i: "Eddik & Sukker" },
            { t: 'd', i: "1 beger lettrømme" },
            { t: 'p', i: "8-10 poteter" }
          ],
          steps: [
            "Skrell potetene og kok dem i en kjele med vann i ca 20-25 minutter.",
            "Lag agurksalat: Bruk en ostehøvel til å skjære agurken i tynne skiver. Ha dem i en skål. Bland 1 dl vann, 2 ss eddik, 2 ss sukker og litt salt/pepper i et glass. Hell over agurken.",
            "Varm en stekepanne på middels varme med smør. Krydre laksestykkene med salt og pepper.",
            "Stek laksen i pannen, ca 3-4 minutter på hver side. Den er ferdig når den er lys rosa tvers igjennom.",
            "Server laksen med poteter, agurksalat og en klatt rømme."
          ]
        }
      ]
    },
    {
      day: "Onsdag",
      options: [
        {
          title: "Tortillapizza",
          description: "Bruk opp rester av lefser.",
          tags: ["Raskt"],
          ingredients: [
            { t: 'g', i: "4-6 tortillalefser" },
            { t: 'g', i: "1 glass pizzasaus" },
            { t: 'm', i: "200g skinke/pepperoni" },
            { t: 'd', i: "300g revet ost" }
          ],
          steps: [
            "Sett ovnen på 225 grader varmluft. Legg bakepapir på stekebrett.",
            "Legg lefser utover brettene.",
            "Smør et tynt lag pizzasaus på hver lefse.",
            "Strø over skinke eller pepperoni. Topp med masse revet ost.",
            "Stek i ovnen i ca. 5-8 minutter. Pass godt på! Lefsene er tynne og kan fort bli brent i kantene. De er ferdige når osten bobler og er gyllen."
          ]
        },
        {
          title: "Bondeomelett",
          description: "Proteinrikt og billig.",
          tags: ["Raskt"],
          ingredients: [
            { t: 'd', i: "8 egg" },
            { t: 'd', i: "1 dl melk" },
            { t: 'm', i: "1 pk skinke/pølserester" },
            { t: 'p', i: "4 kokte poteter (rester)" },
            { t: 'p', i: "1 løk" },
            { t: 'g', i: "Brød" }
          ],
          steps: [
            "Kutt poteter, løk og skinke i terninger.",
            "Varm en stekepanne med smør. Stek løk, potet og skinke til det er gyllent.",
            "Pisk sammen egg, melk, salt og pepper i en bolle.",
            "Hell eggene over blandingen i pannen. Skru varmen ned til middels/lav.",
            "Sett gjerne et lokk over pannen. La den stå til eggene har stivnet helt på toppen (ca 10-15 min).",
            "Server med brødskiver."
          ]
        }
      ]
    },
    {
      day: "Torsdag",
      options: [
        {
          title: "Fiskegrateng",
          description: "Tradisjonsmat.",
          tags: [],
          ingredients: [
            { t: 'm', i: "1 stor fiskegrateng (frossen)" },
            { t: 'p', i: "8-10 poteter" },
            { t: 'p', i: "4 gulrøtter" },
            { t: 'd', i: "50g smør" }
          ],
          steps: [
            "Sett ovnen på 200 grader. Ta plasten av gratengen og sett formen midt i ovnen. Stek i ca 40-50 minutter (sjekk pakken).",
            "Skrell potetene og kok dem møre i vann (ca 20-25 min).",
            "Skrell gulrøttene og rasp dem på rivjern til råkost.",
            "Smelt smør i en liten kjele eller i mikroen.",
            "Når alt er ferdig: Server rykende varm grateng med potet, råkost og smeltet smør."
          ]
        },
        {
          title: "Plukkfisk",
          description: "Hvit saus med fisk og potet.",
          tags: [],
          ingredients: [
            { t: 'm', i: "500g fiskepudding/boller" },
            { t: 'p', i: "8 poteter" },
            { t: 'd', i: "2 ss smør" },
            { t: 'g', i: "2 ss hvetemel" },
            { t: 'd', i: "4 dl melk" },
            { t: 'p', i: "1 purreløk" },
            { t: 'g', i: "Flatbrød" }
          ],
          steps: [
            "Skrell potetene, del dem i terninger og kok dem møre i usaltet vann (ca 10-12 min). Hell av vannet.",
            "Lag hvit saus: Smelt smør i en kjele. Rør inn mel. Spe med melk mens du visper til en glatt saus. Kok i 5 minutter. Krydre med salt, pepper og muskat.",
            "Kutt fiskepuddingen i terninger. Vask og snitt purreløken.",
            "Ha fisketerninger, purre og de kokte potetterningene oppi den hvite sausen.",
            "Rør forsiktig rundt og la det bli varmt på svak varme.",
            "Server med flatbrød."
          ]
        }
      ]
    },
    {
      day: "Fredag",
      options: [
        {
          title: "Taco-Fredag",
          description: "Ingen over, ingen ved siden.",
          tags: ["Helg"],
          ingredients: [
            { t: 'm', i: "400g kjøttdeig" },
            { t: 'g', i: "1 pk tacolefser" },
            { t: 'g', i: "1 pose tacokrydder" },
            { t: 'd', i: "200g revet ost" },
            { t: 'd', i: "1 beger rømme" },
            { t: 'g', i: "1 glass salsa" },
            { t: 'p', i: "Salat, agurk, mais, paprika" },
            { t: 'g', i: "Tortillachips" }
          ],
          steps: [
            "Stek kjøttdeigen brun. Bland inn tacokrydder og vann. Kok inn.",
            "Kutt grønnsaker i små biter.",
            "Legg grønnsaker, ost, saus og chips i skåler.",
            "Varm lefsene i ovn eller mikro.",
            "Nyt fredagen!"
          ]
        },
        {
          title: "Kylling Enchiladas",
          description: "Gratinerte lefser.",
          tags: ["Helg"],
          ingredients: [
            { t: 'm', i: "400g kyllingkjøttdeig" },
            { t: 'g', i: "1 pk store tortillalefser" },
            { t: 'g', i: "1 glass enchilada-saus" },
            { t: 'd', i: "200g revet ost" },
            { t: 'd', i: "1 beger rømme" },
            { t: 'p', i: "1 løk" },
            { t: 'p', i: "1 paprika" }
          ],
          steps: [
            "Sett ovnen på 200 grader.",
            "Hakk løk og paprika. Brun kyllingkjøttdeig i en panne. Ha i grønnsakene og stek til de er myke.",
            "Hell halvparten av enchiladasausen i pannen sammen med kjøttet og rør rundt.",
            "Finn en ildfast form. Legg fyll i hver lefse, rull dem sammen, og legg dem med skjøten ned i formen.",
            "Hell resten av sausen over rullene. Strø over osten.",
            "Stek i ovnen i ca 15 minutter til osten er smeltet og gyllen."
          ]
        }
      ]
    },
    {
      day: "Lørdag",
      options: [
        {
          title: "Hjemmelaget Pizza",
          description: "Lørdagskos.",
          tags: ["Helg"],
          ingredients: [
            { t: 'g', i: "1 pk pizzabunn (eller bak selv)" },
            { t: 'g', i: "1 glass pizzasaus" },
            { t: 'm', i: "400g kjøttdeig" },
            { t: 'd', i: "300g revet ost" },
            { t: 'p', i: "1 løk" },
            { t: 'p', i: "1 paprika" }
          ],
          steps: [
            "Sett ovnen på 225 grader.",
            "Rull ut ferdig pizzabunn på et stekebrett med bakepapir.",
            "Brun kjøttdeig og hakket løk i en stekepanne.",
            "Smør pizzasaus utover bunnen. Fordel kjøttblandingen og hakket paprika utover.",
            "Topp med masse ost.",
            "Stek midt i ovnen i ca 15 minutter (sjekk at bunnen er sprø og osten gyllen)."
          ]
        },
        {
          title: "Hjemmelaget Hamburger",
          description: "Saftige burgere.",
          tags: ["Helg"],
          ingredients: [
            { t: 'm', i: "400g karbonadedeig" },
            { t: 'g', i: "4 hamburgerbrød" },
            { t: 'd', i: "4 skiver ost" },
            { t: 'p', i: "Salat, tomat, løk" },
            { t: 'p', i: "6-8 store poteter (båter)" },
            { t: 'g', i: "Hamburgerdressing" }
          ],
          steps: [
            "Sett ovnen på 225 grader. Vask potetene og kutt dem i båter. Legg på brett, ha på olje, salt og pepper. Stek i ca 30 min.",
            "Mens potetene steker: Del karbonadedeigen i 4 like deler. Form dem til runde, flate burgere med hendene. Krydre med salt og pepper.",
            "Stek burgerne i en panne med smør på middels høy varme, ca 3 minutter på hver side.",
            "Legg en osteskive på hver burger mot slutten av steketiden.",
            "Varm brødene. Monter med dressing, salat, tomat og løk."
          ]
        }
      ]
    },
    {
      day: "Søndag",
      options: [
        {
          title: "Kjøttkaker i brun saus",
          description: "Bestemors oppskrift.",
          tags: [],
          ingredients: [
            { t: 'm', i: "800g kjøttkaker" },
            { t: 'g', i: "1 pose brun saus" },
            { t: 'p', i: "8-10 poteter" },
            { t: 'p', i: "1/2 hodekål" },
            { t: 'd', i: "2 dl melk (til stuing)" },
            { t: 'g', i: "1 ss hvetemel (til stuing)" },
            { t: 'g', i: "Tyttebærsyltetøy" }
          ],
          steps: [
            "Skrell poteter og kok dem møre (ca 25 min).",
            "Lag kålstuing: Kutt kål i terninger. Kok mør i lettsaltet vann (ca 15 min). Hell av vannet. Lag en tykk hvit saus i en kjele (smelt 2 ss smør, rør inn 2 ss mel, spe med 2 dl melk). Bland kålen inn i sausen. Smak til med salt og muskat.",
            "Lag brun saus i en kjele etter anvisning på posen. Legg kjøttkakene oppi og la dem bli varme (ca 10 min).",
            "Server alt sammen med tyttebær."
          ]
        },
        {
          title: "Lapskaus",
          description: "Restemat på sitt beste.",
          tags: [],
          ingredients: [
            { t: 'm', i: "400g pølse eller kjøttrester" },
            { t: 'p', i: "8 poteter" },
            { t: 'p', i: "3 gulrøtter" },
            { t: 'p', i: "1/2 kålrot" },
            { t: 'p', i: "1 purreløk" },
            { t: 'g', i: "2 buljongterninger" },
            { t: 'g', i: "Flatbrød" }
          ],
          steps: [
            "Skrell poteter, gulrøtter og kålrot. Kutt ALLE grønnsakene og pølse/kjøtt i terninger (ca like store biter).",
            "Ha potet, gulrot og kålrot i en stor kjele. Fyll på vann til det akkurat dekker grønnsakene. Ha i buljongterningene.",
            "Kok opp og la det småkoke til grønnsakene er møre (ca 15-20 min).",
            "Ha i kjøtt/pølse og purreløk. La det trekke i 5-10 minutter til.",
            "Rør litt hardt rundt så noen av potetene moser seg og jevner (tykner) lapskausen. Smak til med pepper.",
            "Server med flatbrød."
          ]
        }
      ]
    }
  ]
};

// --- LOGIKK FOR SAMMENSLÅING ---

const consolidateIngredients = (rawList) => {
  const consolidated = {};

  rawList.forEach(item => {
    // 1. Normaliser navnet for å finne "nøkkelen" (f.eks. "400g kjøttdeig" -> "kjøttdeig")
    let lowerItem = item.toLowerCase().trim();
    
    // Regex for å skille mengde fra navn. 
    // Fanger opp tall i starten, og enheter som g, kg, stk, pk, boks, ss, dl, l
    const regex = /^([\d\.,\/-]+(?:\s*[a-zA-Zæøå]+)?)\s+(.*)$/;
    const match = lowerItem.match(regex);

    let key = lowerItem; // Default key er hele strengen
    let quantity = "";

    if (match) {
      quantity = match[1]; // F.eks "400g" eller "1 boks"
      key = match[2];      // F.eks "kjøttdeig" eller "hakkede tomater"
    } else {
      // Hvis ingen mengde er spesifisert (f.eks "Salt og pepper")
      key = lowerItem;
      quantity = "1 stk"; // Antar 1 stk hvis ikke annet er nevnt for å få det med i listen
      
      // Unntak for ting som åpenbart ikke skal ha "1 stk" foran seg visuelt, men logikken holder.
    }

    // Capitalize key for display
    const displayKey = key.charAt(0).toUpperCase() + key.slice(1);

    if (!consolidated[displayKey]) {
      consolidated[displayKey] = [];
    }
    consolidated[displayKey].push(quantity);
  });

  // Format the output: "Kjøttdeig (400g + 400g)"
  const finalOutput = [];
  Object.keys(consolidated).sort().forEach(key => {
    const quantities = consolidated[key];
    // Hvis vi har flere forekomster, slå dem sammen visuelt
    if (quantities.length > 1) {
      finalOutput.push(`${key} (${quantities.join(' + ')})`);
    } else {
      // Hvis det bare er én, og mengden ikke er "1 stk" (eller hvis det ser naturlig ut)
      const qty = quantities[0];
      // Sjekk om qty er en del av navnet (hvis regex feilet) eller om det ser bra ut
      if (qty && qty !== "1 stk") {
         finalOutput.push(`${qty} ${key.toLowerCase()}`);
      } else {
         finalOutput.push(key);
      }
    }
  });

  return finalOutput;
};


// --- KOMPONENTER ---

const RecipeDetail = ({ meal, onClose }) => (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center z-10">
        <div>
          <h2 className="text-2xl font-bold text-gray-800">{meal.title}</h2>
          <span className="text-sm text-gray-500 uppercase tracking-wider">Oppskrift & Ingredienser</span>
        </div>
        <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
          <X size={24} />
        </button>
      </div>
      
      <div className="p-6 space-y-8">
        <div>
          <h3 className="font-bold text-lg mb-3 flex items-center gap-2 border-b pb-2 text-slate-700">
            <ShoppingCart size={20} className="text-blue-500" />
            Du trenger
          </h3>
          <ul className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
            {meal.ingredients.map((ing, i) => (
              <li key={i} className="flex items-start gap-3 text-gray-700 p-2 rounded hover:bg-gray-50">
                <div className="mt-1.5 w-2 h-2 rounded-full bg-blue-400 flex-shrink-0" />
                <span className="leading-snug">{ing.i}</span>
              </li>
            ))}
          </ul>
        </div>

        <div>
          <h3 className="font-bold text-lg mb-4 flex items-center gap-2 border-b pb-2 text-slate-700">
            <Utensils size={20} className="text-orange-500" />
            Slik gjør du
          </h3>
          <ol className="space-y-6">
            {meal.steps.map((step, i) => (
              <li key={i} className="flex gap-4">
                <div className="flex-shrink-0 w-8 h-8 bg-orange-100 text-orange-700 rounded-full flex items-center justify-center font-bold text-sm shadow-sm border border-orange-200">
                  {i + 1}
                </div>
                <p className="text-gray-700 mt-1 leading-relaxed">{step}</p>
              </li>
            ))}
          </ol>
        </div>
      </div>
    </div>
  </div>
);

const ShoppingListView = ({ generatedList }) => {
  const [checkedItems, setCheckedItems] = useState({});

  const toggleItem = (item) => {
    setCheckedItems(prev => ({
      ...prev,
      [item]: !prev[item]
    }));
  };

  const copyToClipboard = () => {
    let text = "";
    Object.keys(CAT_LABELS).forEach(key => {
      const items = consolidateIngredients(generatedList[key] || []);
      if (items.length > 0) {
        text += `\n--- ${CAT_LABELS[key]} ---\n`;
        text += items.join('\n');
      }
    });
    navigator.clipboard.writeText(text);
    alert('Handleliste kopiert!');
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-xl font-bold text-gray-800">Dynamisk Handleliste</h2>
        <button 
          onClick={copyToClipboard}
          className="flex items-center gap-2 text-sm bg-blue-50 text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-100 font-medium transition-colors"
        >
          <Copy size={16} /> Kopier
        </button>
      </div>
      
      <div className="space-y-8">
        {Object.keys(CAT_LABELS).map(catKey => {
          // Her kjører vi den nye konsolideringsfunksjonen før visning
          const items = consolidateIngredients(generatedList[catKey] || []);
          
          if (!items || items.length === 0) return null;

          return (
            <div key={catKey} className="bg-gray-50/50 rounded-lg p-4">
              <h3 className="font-bold text-slate-700 text-sm uppercase tracking-wider mb-3 border-b border-gray-200 pb-2">
                {CAT_LABELS[catKey]}
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                {items.map((item, idx) => (
                  <div 
                    key={idx} 
                    onClick={() => toggleItem(item)}
                    className={`flex items-start gap-3 p-2 rounded-lg cursor-pointer transition-all ${
                      checkedItems[item] 
                        ? 'text-gray-400 line-through' 
                        : 'hover:bg-white hover:shadow-sm text-gray-700'
                    }`}
                  >
                    <div className={`mt-0.5 w-5 h-5 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${
                      checkedItems[item] ? 'bg-green-500 border-green-500' : 'bg-white border-gray-300'
                    }`}>
                      {checkedItems[item] && <Check size={14} className="text-white" />}
                    </div>
                    <span className="text-sm leading-snug">{item}</span>
                  </div>
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

const MealCard = ({ dayData, selectedIndex, onSwap, onClick }) => {
  const meal = dayData.options[selectedIndex];
  const isQuick = meal.tags.includes('Raskt');
  const isWeekend = meal.tags.includes('Helg');

  let bgColor = "bg-white";
  let borderColor = "border-gray-200";
  let icon = <Utensils size={16} className="text-gray-400" />;

  if (isQuick) {
    bgColor = "bg-blue-50/30";
    borderColor = "border-blue-200";
    icon = <Clock size={16} className="text-blue-500" />;
  } else if (isWeekend) {
    bgColor = "bg-orange-50/30";
    borderColor = "border-orange-200";
    icon = <Star size={16} className="text-orange-500" />;
  }

  return (
    <div className={`rounded-xl border ${borderColor} ${bgColor} shadow-sm hover:shadow-md transition-all flex flex-col group`}>
      <div 
        onClick={() => onClick(meal)}
        className="p-5 cursor-pointer flex-grow"
      >
        <div className="flex justify-between items-center w-full mb-3">
          <span className="font-bold text-slate-500 text-xs uppercase tracking-wider">{dayData.day}</span>
          <div className="flex gap-2">
            {isQuick && (
              <span className="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full font-bold">
                RASK
              </span>
            )}
            {icon}
          </div>
        </div>
        <h3 className="font-bold text-gray-900 text-lg leading-tight mb-2 group-hover:text-blue-700 transition-colors">{meal.title}</h3>
        <p className="text-sm text-gray-600 line-clamp-2">{meal.description}</p>
      </div>

      <div className="px-5 py-3 border-t border-gray-100 bg-gray-50/50 rounded-b-xl flex justify-between items-center">
        <span className="text-xs text-gray-400 font-medium">
          Alternativ {selectedIndex === 0 ? "A" : "B"}
        </span>
        <button 
          onClick={(e) => { e.stopPropagation(); onSwap(); }}
          className="flex items-center gap-1.5 text-xs font-bold text-slate-600 hover:text-blue-600 bg-white border border-gray-200 hover:border-blue-200 px-3 py-1.5 rounded-full transition-all shadow-sm"
        >
          <ArrowLeftRight size={12} />
          Bytt rett
        </button>
      </div>
    </div>
  );
};

const App = () => {
  const [view, setView] = useState('menu'); 
  const [selectedMeal, setSelectedMeal] = useState(null);
  const [selections, setSelections] = useState({});

  const handleSwap = (week, dayIdx) => {
    const key = `${week}-${dayIdx}`;
    setSelections(prev => ({
      ...prev,
      [key]: prev[key] === 1 ? 0 : 1
    }));
  };

  const getSelectedIndex = (week, dayIdx) => {
    return selections[`${week}-${dayIdx}`] || 0;
  };

  const currentShoppingList = useMemo(() => {
    const list = { p: [], m: [], d: [], g: [] };
    
    [1, 2].forEach(week => {
      weeksData[week].forEach((dayData, dayIdx) => {
        const selectedIdx = getSelectedIndex(week, dayIdx);
        const meal = dayData.options[selectedIdx];
        
        meal.ingredients.forEach(ing => {
          if (list[ing.t]) {
            list[ing.t].push(ing.i); 
          }
        });
      });
    });
    return list;
  }, [selections]);

  const handlePrint = () => window.print();

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans pb-24">
      <div className="max-w-5xl mx-auto space-y-6">
        
        {/* Header */}
        <div className="bg-slate-900 rounded-2xl shadow-xl overflow-hidden print:bg-white print:text-black print:shadow-none">
          <div className="p-6 md:p-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div>
              <h1 className="text-2xl md:text-3xl font-black text-white print:text-black tracking-tight">Interaktiv Matplan</h1>
              <p className="text-slate-400 text-sm md:text-base print:text-gray-600 mt-1">
                Velg retter • Se oppskrifter • Få handleliste
              </p>
            </div>
            
            <div className="flex bg-slate-800 p-1.5 rounded-xl print:hidden border border-slate-700">
              <button 
                onClick={() => setView('menu')}
                className={`px-5 py-2.5 rounded-lg text-sm font-bold transition-all ${view === 'menu' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}
              >
                Ukeplan
              </button>
              <button 
                onClick={() => setView('shopping')}
                className={`px-5 py-2.5 rounded-lg text-sm font-bold transition-all ${view === 'shopping' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}
              >
                Handleliste
              </button>
            </div>
          </div>
        </div>

        {/* Content Area */}
        {view === 'menu' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 animate-in slide-in-from-bottom-4 duration-500">
            {/* Week 1 */}
            <div className="space-y-4">
              <div className="flex items-center gap-3 pb-3 border-b-2 border-slate-200">
                <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-700">1</div>
                <h2 className="text-xl font-black text-slate-800 uppercase tracking-wide">Uke 1</h2>
              </div>
              <div className="space-y-4">
                {weeksData[1].map((dayData, idx) => (
                  <MealCard 
                    key={idx} 
                    dayData={dayData} 
                    selectedIndex={getSelectedIndex(1, idx)}
                    onSwap={() => handleSwap(1, idx)}
                    onClick={setSelectedMeal} 
                  />
                ))}
              </div>
            </div>
            
            {/* Week 2 */}
            <div className="space-y-4">
              <div className="flex items-center gap-3 pb-3 border-b-2 border-slate-200">
                <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-700">2</div>
                <h2 className="text-xl font-black text-slate-800 uppercase tracking-wide">Uke 2</h2>
              </div>
              <div className="space-y-4">
                {weeksData[2].map((dayData, idx) => (
                  <MealCard 
                    key={idx} 
                    dayData={dayData} 
                    selectedIndex={getSelectedIndex(2, idx)}
                    onSwap={() => handleSwap(2, idx)}
                    onClick={setSelectedMeal} 
                  />
                ))}
              </div>
            </div>
          </div>
        )}

        {view === 'shopping' && (
          <div className="space-y-8 animate-in slide-in-from-right-4 duration-300">
             <div className="bg-blue-50 border border-blue-100 p-5 rounded-xl text-blue-900 text-sm mb-4 flex gap-3">
               <div className="mt-0.5"><Clock size={18} /></div>
               <div>
                 <strong>Tips:</strong> Listen oppdateres automatisk og slår sammen like varer (f.eks "Løk: 1 stk + 1 stk"). 
                 Husk å sjekke om du allerede har basisvarer som krydder, smør og mel hjemme.
               </div>
             </div>
            <ShoppingListView generatedList={currentShoppingList} />
          </div>
        )}

      </div>

      {/* Recipe Modal */}
      {selectedMeal && (
        <RecipeDetail meal={selectedMeal} onClose={() => setSelectedMeal(null)} />
      )}

      {/* Print Button */}
      <button 
        onClick={handlePrint}
        className="fixed bottom-8 right-8 bg-slate-900 text-white p-4 rounded-full shadow-2xl hover:bg-blue-600 transition-colors print:hidden z-40"
        title="Skriv ut plan"
      >
        <Printer size={28} />
      </button>
    </div>
  );
};

export default App;
